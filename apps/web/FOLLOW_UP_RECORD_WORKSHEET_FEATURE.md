# 覆診記錄工作紙功能說明

## 功能概述

基於勾選的覆診記錄生成列印工作紙，採用橫向 A4 表格格式，每頁顯示多個覆診記錄。

## 功能特點

### 1. 設計理念
- **資料來源**：基於用戶在覆診管理頁面勾選的記錄
- **輸出格式**：HTML/PDF 列印
- **佈局**：橫向 A4，表格形式，一個覆診佔一行
- **分頁**：每頁約 25 條記錄，自動分頁

### 2. 欄位設計

工作紙包含以下欄位：
- **日期**：覆診日期（完整日期格式）
- **床號**：院友床號
- **院友姓名**：院友中文姓名
- **出發時間**：出發時間（HH:MM）
- **覆診時間**：覆診時間（HH:MM）
- **覆診地點**：覆診地點
- **覆診專科**：覆診專科
- **陪診**：陪診人員
- **交通**：交通安排
- **備註**：備註信息

### 3. 排序規則

- **按日期排序**：由近到遠（最近的日期在前）
- 自動根據覆診日期排序，無需手動調整

### 4. 頁面佈局

- **頁首**：包含標題「覆診記錄工作紙」、生成日期、頁碼
- **主體**：表格顯示所有勾選的覆診記錄
- **頁尾**：顯示總記錄數
- **分頁**：每頁約 25 條記錄，超過自動分頁

## 檔案結構

### 核心檔案

1. **工作紙生成器**
   - 路徑：`apps/web/src/utils/followUpRecordWorksheetGenerator.ts`
   - 功能：
     - 接收勾選的覆診記錄數據
     - 按日期排序（由近到遠）
     - 生成 HTML 表格
     - 自動分頁處理
     - 開啟列印窗口

### 修改檔案

1. **覆診管理頁面**
   - 路徑：`apps/web/src/pages/FollowUpManagement.tsx`
   - 修改：
     - 導入工作紙生成器
     - 添加「覆診記錄工作紙」按鈕（僅在有勾選記錄時顯示）
     - 實現 `handleExportWorksheet` 函數
     - 準備並傳遞勾選的記錄數據

## 使用方法

### 操作步驟

1. 進入覆診管理頁面
2. 使用表格左側的勾選框勾選要匯出的覆診記錄
   - 可以勾選任意數量的記錄
   - 可以使用篩選和搜索功能縮小範圍
3. 勾選後，頂部會顯示「覆診記錄工作紙」按鈕
4. 點擊「覆診記錄工作紙」按鈕
5. 系統會自動：
   - 收集勾選的記錄
   - 按日期排序（由近到遠）
   - 生成工作紙
   - 開啟新窗口顯示
6. 使用瀏覽器的列印功能列印（Ctrl+P 或 Cmd+P）

### 列印設置建議

- **紙張大小**：A4
- **方向**：橫向（Landscape）
- **邊距**：15mm（上下），10mm（左右）
- **縮放**：100%（已優化）

## 技術實現

### 核心技術

1. **數據處理**
   ```typescript
   - 從覆診管理頁面獲取勾選的記錄
   - 轉換為標準格式
   - 按覆診日期排序（由近到遠）
   - 格式化時間為 HH:MM
   ```

2. **HTML 生成**
   ```typescript
   - 使用模板字符串構建 HTML
   - CSS 樣式內嵌
   - 自動分頁（每頁 25 條）
   - 列印優化
   ```

3. **分頁處理**
   ```typescript
   - 計算總頁數
   - 分組記錄（每組 25 條）
   - 為每頁生成獨立的頁面結構
   - 使用 page-break-after 控制分頁
   ```

4. **列印處理**
   ```typescript
   - window.open() 開啟新窗口
   - document.write() 寫入 HTML
   - window.print() 觸發列印
   - @page CSS 規則控制頁面設置
   ```

### 樣式特點

- **表格**：完整邊框，灰色標題行
- **標題行**：固定在每頁頂部
- **斑馬線**：偶數行灰色背景，便於閱讀
- **懸停效果**：鼠標懸停時行背景變色
- **顏色**：使用 `print-color-adjust: exact` 確保列印時保留背景色

### 數據接口

```typescript
interface FollowUpRecordData {
  覆診id: string;
  院友id: number;
  覆診日期: string;
  出發時間?: string;
  覆診時間?: string;
  覆診地點?: string;
  覆診專科?: string;
  交通安排?: string;
  陪診人員?: string;
  備註?: string;
  院友: {
    床號: string;
    中文姓氏: string;
    中文名字: string;
  };
}
```

## 使用場景

1. **批量列印覆診記錄**
   - 選擇特定日期範圍的覆診記錄
   - 一次性列印所有記錄

2. **特定院友覆診記錄**
   - 使用篩選功能選擇特定院友
   - 列印該院友的所有覆診記錄

3. **特定地點或專科**
   - 篩選特定覆診地點或專科
   - 批量列印相關記錄

4. **定期報表**
   - 選擇一段時間內的覆診記錄
   - 生成定期報表

## 優勢特點

1. **靈活性**：可以選擇任意數量和範圍的記錄
2. **便捷性**：一鍵生成，無需額外配置
3. **自動化**：自動排序和分頁
4. **專業性**：統一的表格格式，便於歸檔
5. **可追溯**：顯示生成日期和總記錄數

## 注意事項

1. **勾選記錄**：必須先勾選至少一條記錄才能生成工作紙
2. **排序固定**：按日期由近到遠排序，不可調整
3. **瀏覽器兼容**：建議使用 Chrome 或 Edge 瀏覽器以獲得最佳列印效果
4. **分頁自動**：超過 25 條記錄會自動分頁
5. **列印預覽**：建議先預覽再列印，確保格式正確

## 與其他匯出功能的對比

| 功能 | 覆診記錄工作紙 | 覆診記錄表（Excel） | CSV 匯出 |
|------|----------------|---------------------|----------|
| 格式 | HTML/PDF 列印 | Excel | CSV |
| 用途 | 列印存檔、現場使用 | 電子存檔、編輯 | 數據交換 |
| 數量限制 | 無限制 | 最多 17 筆 | 無限制 |
| 排序 | 按日期（由近到遠） | 按選擇順序 | 按選擇順序 |
| 工作表 | 單一表格 | 覆診記錄表+覆診袋封面 | 純數據 |

## 未來改進建議

1. 支持自定義排序方式（按床號、按地點等）
2. 增加更多篩選快捷鍵（如「本週」、「本月」）
3. 支持直接匯出為 PDF 檔案
4. 增加預覽功能
5. 支持自定義欄位顯示/隱藏
6. 支持自定義每頁記錄數
7. 增加統計信息（如按地點、專科分類統計）
